\cleartooddpage[\thispagestyle{empty}]
\newcommand{\EReco}{$\textrm{E}_{\textrm{Reconstructed}}$}
\newcommand{\ETrue}{$\textrm{E}_{\textrm{True}}$}

\chapter{Gamma-Ray Reconstruction Methods}\label{ch:grrecon}

Chapter \ref{chapter:veritas} explained how the trigger system initializes the readout of PMT voltage traces.
This chapter describes how gamma rays are reconstructed.
In gamma-ray reconstruction, voltage traces induced by Cherenkov photons must be identified and combined to form an image of the original Cherenkov shower.
Then the shower images from multiple telescopes can be used to reconstruct the original gamma ray's energy and direction.

Throughout the rest of this thesis, \textit{Galactic Center} and \textit{Sgr A*} are used to describe the main analysis region.
While in astrophysics \textit{Galactic Center} refers to the several-degree-radius area around the center of our galaxy, \textit{Sgr A*} refers to the specific central gamma-ray point source (<\ang{0.2} radius).
VERITAS data observations that cover this point source are also referred to as \textit{Sgr A*} data, described further in Section~\ref{veritasdata}.


\section{Pedestal Variation}
Before reconstructing any events, the pedestal and pedestal variations must be calculated.
This is done by artificially triggering all pixels once per second during observations, in order to record events that contain only noise.
The \textit{pedestal} is the average of the digital counts (dc) of all noise events for each pixel.
From this pedestal, the pedestal variations are then calculated for each pixel as the root mean square of all the dc counts in all noise events, which can be visualized as the distribution of dc around the mean dc.
In this context, noise events can be due to night-sky-background photons, or from electronic noise.

\section{Pixel Identification}
The first step to reconstruct events is to determine which pixels are part of a shower image.
This is done by subtracting the dc pedestal from the entire trace, and then summing all trace bins within a fixed window, called the integration length, to get the total dc.

Most voltage traces have the same general shape: a quickly rising start of the pulse, followed by a longer, slowly falling tail.
This can be seen in Figure~\ref{fig:pmt_pulse_widths} in the previous chapter.
To act as a point of reference in each voltage pulse, the time when the voltage trace is at half of its maximum value is called $T_{0}$.
The trace is then integrated a second time using a smaller 14- or 24-ns-wide time window, starting at $T_0 - 30\%$, to reduce the inclusion of dc from NSB photons and electronic noise.
This integration is the first of two passes, usually referred to as the double-pass method~\cite{doublepass}.
If a pixel's first-pass total dc is higher than 5 times the pedestal variation, then it is classified as an image pixel.
If it is between 2.5 and 5 times the pedestal variation, it is considered a border pixel.

Once all pixels have been classified, isolated border pixels that have no neighboring image pixel are removed from the image, as they are more likely to be due to noise than Cherenkov photons.
Then, the time gradient from the image and border pixels can be found by performing a linear fit of the $T_{0}$ times.
This time gradient can then be used to place a third integration window 
with 30\% of the window before each pixel's $T_{0}$, to more accurately measure the charge due to Cherenkov photons in the pixel.
This third integration window is the second pass in the double-pass method.

From the image pixels, border pixels, and time gradient, the shower's Hillas parameters~\cite{hillas_params} can be calculated.
These parameters include the shower size in photoelectrons (or equivalent units), center of charge, angle, length, and width.
The center of charge is the charge-weighted average of all image and border pixel positions.
The angle of the shower determines how the image's major axis is oriented in the camera.
The shower length and width are determined by the root mean square of the shower image along its major and minor axes, respectively, as shown in Figure~\ref{fig:shower_param}.
  
\begin{figure}[t]
  \centering
  \includegraphics[width=0.45\textwidth]{images/shower_parameter_diagram/diagram.pdf}
  \caption[Basic Shower Diagram]{
    An example shower image in one VERITAS camera.
    The grey circles are the locations of PMTs.
    Red circles are PMTs that have detected Cherenkov photons.
  }
  \label{fig:shower_param}
\end{figure}
\FloatBarrier

\section{Position Reconstruction}\label{subsec:posrecon}
By examining the images from multiple telescopes, the initial direction of the event can be determined.
This is done by overlapping all telescope images in a single camera coordinate system, and projecting each image's major axis backward in time.
These axes should intersect very close together, and the average of the intersection points determines the event's initial direction.
The axes tend to not intersect perfectly, as atmospheric absorption and night sky background photons can add and remove photons from the shower image.

When averaging the intersection points, weights can be applied to each intersection based on the angle between the two lines.
This improves the reconstruction, because the intersection point from two images at \ang{90} angles will be less sensitive to image fluctuations than two images at \ang{160}, as shown in Figure~\ref{fig:largeintersectangle}.
Additionally, the \textit{disp} method is explored in Section~\ref{subsec:disp} to provide improvements at lower telescope elevations.
This would be beneficial as the Galactic Center is at a low (<\ang{50}) telescope elevation (see Figure~\ref{fig:datapointingelevations}).

\begin{figure}[!t]
  \centering
  \includegraphics[width=0.95\textwidth]{images/large_angle_image_intersection_error/laiie_cropped.pdf}
  \caption[Large Image Intersection Angles]{
    In diagram (a), when a noisy pixel is added to an image, the reconstructed position is only moved a small distance (the purple arrow).
    In diagram (b), due to the large angle between images, the error in the reconstructed position is much larger.
  }
  \label{fig:largeintersectangle}
\end{figure}
\FloatBarrier

\subsection{Angular Reconstruction with Boosted Decision Trees}\label{subsec:disp}
At high elevations, shower images often form small intersection angles, because the telescopes are spread out in two dimensions, relative to the shower in the atmosphere.
At low elevations near the Galactic Center, however, the telescope array flattens into one dimension, which makes the shower's impact parameter (the shortest distance between the telescope and the shower core axis) smaller for two of the telescopes.
These two closer telescopes then have very short, almost circular images, which makes them more sensitive to noisy pixels or shower fluctuations, as shown in Figure~\ref{fig:showerhighlowelev}.
This also causes the remaining telescope images to have large intersection angles, which also reduces the accuracy of the position reconstruction.

\begin{figure}[!t]
  \centering
  \includegraphics[width=0.75\textwidth]{images/high_elevation_vs_low_shower_images_cropped.eps}
  \caption[Shower Images at High and Low Elevations]{
    In Figure (a), high elevation showers produce long images in all four telescopes.
    In Figure (b), lower elevation showers produce shortened images in two telescopes, and the remaining images form large angle intersection.
  }
  \label{fig:showerhighlowelev}
\end{figure}

To better handle these near-parallel image axes at low elevations, the reconstructed position can be determined from more parameters than just the weighted image axes intersection points.
From simulations, the distance between the center of the Hillas shower image and the true position can be calculated, where the angular distance between the two is the disp parameter~\cite{Senturk:2011}, shown in Figure~\ref{fig:dispdiagram}.
Then, this disp parameter can be provided to a machine learning algorithm~\cite{Beilicke2012NIM}, along with other image parameters like:
\begin{quote}
  \begin{description}[noitemsep]
    \item [width:] image angular width
    \item [length:] image angular length
    \item [wol:] $\frac{\textrm{width}}{\textrm{length}}$
    \item [size:] total image dc
    \item [ntubes:] number of pixels in the image
    \item [loss:] fraction of image pixels at the edge of the camera
    \item [asym:] distance between image center-of-dc and the pixel with the highest dc
    \item [tgrad:] the slope of the linear time fit to the pixel arrival times
    \item [cross:] angular distance between the image center and the average intersection point of the image axes.
  \end{description}
\end{quote}
% list of training parameters: grep "AddVariable" $EVNDISPSYS/src/trainTMVAforAngularReconstruction.cpp
% how variables are calculated: grep -P "fParGeo.+\=" $EVNDISPSYS/src/VImageParameterCalculation.cpp
% asym: http://inspirehep.net/record/1395717/files/RdelosReyes.pdf
% Once trained on these parameters, the machine learning algorithm can construct a boosted decision tree for determining any new image's \textit{disp}, which can then be used with the image axes intersections to improve the gamma-ray reconstructed positions.


\begin{figure}[t]
  \centering
  \includegraphics[width=0.5\textwidth]{images/disp_parameter/disp_parameter.pdf}
  \caption[Angular Reconstruction Disp]{
    The disp parameter is the angular distance between the center (red dot) of a Hillas image (blue oval) and the true sky position (green dot).
    Generally, longer shower images have a larger disp angle.
  }
  \label{fig:dispdiagram}
\end{figure}

% https://veritas.sao.arizona.edu/wiki/index.php/BDT_Angular_reconstruction
These parameters for thousands of simulated showers can then be used to train boosted decision trees (BDTs) that estimate the disp for a new shower's images.
This estimated disp can then be combined with the image axes intersection points to more accurately reconstruct the original gamma-ray point of origin.

Once the training is complete, it is tested on a separate set of 17,000 simulated events, whose true and predicted disps plotted in Figure~\ref{fig:disptraining}.
The x-axis describes the true disp value for each event, while the y-axis describes the disp value estimated by the BDT, with a black $x=y$ line marked, which represents a perfect 1:1 disp reconstruction.
To examine how close the predicted disp is to the true disp, a residual plot is shown in Figure~\ref{fig:dispresidual}.
It shows the $\frac{\textrm{Predicted disp}}{\textrm{True disp}}$ for each true disp bin, including $\pm$ 1 standard deviation errorbars.
From this residual plot, it can be seen that in nearly all bins the predicted disp is consistant with the true disp.

% made from screenshot of last slide in Dropbox/Presentations/20160719_Group_Meeting.key
\begin{figure}[b]
  \centering
  \includegraphics[width=0.85\textwidth]{images/disp_training/disp_training.eps}
  \caption[Disp BDT Training]{
    The true disp vs the BDT-predicted disp, for \nicetilde17,000 gamma-ray event images in T1, from \SI{500}{\GeV{}} to \SI{200}{\TeV{}}.
  }
  \label{fig:disptraining}
\end{figure}

\begin{figure}[t]
  \centering
  \includegraphics[width=0.85\textwidth]{images/disp_training/improved_disp_plot/plot.pdf}
  \caption[Disp BDT Residual]{
    The predicted/true disp residual, from the bins in Figure~\ref{fig:disptraining}.
    The errorbars represent 1 standard deviation.
    The graph is split at $x=0.75^{\circ}$ to keep the errorbars visible.
  }
  \label{fig:dispresidual}
\end{figure}

To examine the effect this disp method has on an analysis, the point spread functions (PSFs) are compared.
The PSF describes how much a group of events from the same source are spread out due to being imperfectly reconstructed.
In general, PSFs are quantified by their 68\% containment radius, the anglular radius around a point source which contains 68\% of the reconstructed events.
PSFs are discussed further in Section~\ref{subsec:psf}.
The PSF containment radius is calculated from simulations, with both the disp reconstruction method and the regular geometric reconstruction method.
The ratio of the $\frac{\textrm{disp PSF radius}}{\textrm{geometric PSF radius}}$ is shown in Figure~\ref{fig:disp_psf_comparison}.
Because the PSF changes with telescope elevation, telescope azimuth and zenith, night sky background noise, atmosphere, and offset from the camera center, the average PSF at each gamma-ray energy is shown.
This PSF is calculated by a time-weighted averaging over all PSFs used in the two datasets used in this analysis, the Crab Nebula and the Galactic Center, described further in Chapter~\ref{chapter:analysis}.
The average PSF for the Crab Nebula data is shown by a green line and a green 1-standard-deviation error sheath, and similarly the Galactic Center is shown in blue.
    
In Figure~\ref{fig:disp_psf_comparison}, the disp method does offer a minor improvement at low energies, but is worse at higher energies, though both are within the statistical error bars.
The lack of improvement may be due to the use of boosted decision trees, whereas a previous study with this method utilized a lookup table of six parameters, described in Ref.~\cite{Beilicke2012NIM}.
For the analysis described in Chapter~\ref{chapter:analysis}, the disp method is used when reconstructing gamma-ray events.
    
\begin{figure}[b]
  \centering
  \includegraphics[width=0.95\textwidth]{images/disp_event_offset_hists/plot_offset0_50.pdf}
  \caption[DISP Point Spread Function Comparison]{
    Comparison between the disp and geometric point spread function 68\% containment radii.
    The lines represent the average ratio, with a 1 standard deviation error sheath.
    Green is from the Crab Nebula data, and blue is from the Galactic Center data.
    The average PSF shown is at a \ang{0.5} offset from the camera center.
  }
  \label{fig:disp_psf_comparison}
\end{figure}

\FloatBarrier

\section{Energy Reconstruction}\label{subsec:enrecon}

To reconstruct the energy of each shower, a lookup table of simulated showers is assembled.
This database includes the width and length of the shower, how far away its core position is from the telescopes, how bright it is, as well as its reconstructed and true energy.
These parameters all change with each telescope, noise level, azimuth and zenith angle, offset from camera center, and epoch.
At each point in the (core position, brightness, telescope, noise level, azimuth and zenith angle, camera offset, epoch) parameter space, the shower lengths and widths form a gaussian distribution.
If the parameter space points were combined, they would result in a non-gaussian shape.
The table therefore tracks (at each point in the parameters space) the median and spread of each distribution of shower length and width.

One point in the parameter space of this database is shown in Figure~\ref{fig:energy_params}.
In the left plot, the median shower width is shown at at several shower core distances and image sizes.
In the right plot, the spread in the width distribution is shown at the same distances and sizes.
By searching through this database for showers that are similar to the one being reconstructed, then interpolating between shower parameters, the shower's true energy can be reconstructed.

\begin{figure}[bh]
  \centering
  \includegraphics[width=\textwidth]{images/energy_table_plots/energy.pdf} &
  \caption[Energy Table Parameters]{
    Plots of the energy table parameters.
    The median shower energy is shown in the left plot, at several shower core distances and image sizes.
    The right plot shows the $2\sigma$ spread in energy at the same parameter space points.
    {\color{red}(ask gernot if median or mean is better??)}
  }
  \label{fig:energy_params}
\end{figure}


\section{Gamma-Hadron Separation}

After characterizing the parameters of each shower, the gamma-ray showers must be selected, and the proton showers filtered out.
Monte Carlo simulations of gamma-ray showers are performed at many energies, impact parameters (distance from the core position on the ground and the array center), shower directions, and night sky background levels.
At each point in this parameter space, the distribution of shower lengths and widths are measured, and the median length ($l_{\textrm{median}}$) and width ($w_{\textrm{median}}$) plus the 90\%-distribution-spread for the lengths and widths ($l_{\textrm{spread}}$, $w_{\textrm{spread}}$) are saved to a table.
{\color{red}(ask gernot about 90\% distribution spread??)}
{\color{red}(double check that this paragraph flows correctly??)}
These measured lengths and width are shown in Figure~\ref{fig:mscw_params}.

\begin{figure}[bh]
  \centering
  \includegraphics[width=\textwidth]{images/mscw_table_plots/mscw.pdf} &
  \caption[Mean Scaled Width Table Parameters]{
    Plots of the shower width table parameters.
    The median shower width is shown in the left plot, at several shower core distances and image sizes.
    The right plot shows the $2\sigma$ spread at the same parameter space points.
    {\color{red}(ask gernot if median or mean is better??)}
  }
  \label{fig:mscw_params}
\end{figure}

Then for each shower, a Mean Scaled Length (MSCW) and Mean Scaled Width (MSCW) can be calculated with Equation~\ref{eqn:mscwl}.

\begin{equation}\label{eqn:mscwl}
  \begin{split}
    \textrm{MSCW}_{\textrm{shower}} & = \frac{w_{\textrm{shower}}-w_{\textrm{median}}}{w_{\textrm{spread}}} \\
    \textrm{MSCL}_{\textrm{shower}} & = \frac{l_{\textrm{shower}}-l_{\textrm{median}}}{l_{\textrm{spread}}}
  \end{split}
\end{equation}


Gamma-ray showers and proton showers have different distributions of MSCW and MSCL (proton showers tend to be wider), so cuts are applied on these two parameters to partially filter out the proton showers.
See Ref.~\cite{Krause2017} for a more thorough discussion on gamma-hadron separation.

\section{FITS Conversion for Gammalib and CTOOLs}\label{fitsconversion}
Once gamma rays have been reconstructed with Eventdisplay, they must be exported to Gammalib and CTOOLS~\cite{gammalibctools}.
Gammalib and CTOOLS are software that perform the likelihood calculation, which is described further in Section~\ref{sec:likeratio}.
This software posesses several useful features, including automatic model convolution with instrument response functions (IRFs) and easier comparison with results from other gamma-ray telescopes like H.E.S.S. and MAGIC.
This software is also one of the main high-level analysis tools to be used by the Cherenkov Telescope Array (CTA), making it and easier to include VERITAS data into future CTA analyses.

Exporting gamma-ray data to this software involves converting the event list and IRFs to a FITS file format.
The IRFs consist of the effective areas, the point spread functions, the background models, and the energy dispersion.
The effective area quantifies the total gamma-ray collection area of the observatory, which is needed for spectral measurements.
The point spread function quantifies the distribution of reconstructed positions for a given true position, which is needed for modeling point sources and extended spatial structures.
The background models measure the relative number of observed events in different parts of the camera.
The energy dispersion quantifies the distribution of reconstructed energies for a given true energy.

During the export, several decisions are baked into the event lists and IRFs.
As this thesis revolves around an analysis at an elevation of \nicetilde{}\ang{30}, the IRFs may rapidly change.
At this elevation, with VERITAS's field of view of \ang{3.5}, the airmass column density ($\textrm{g}/\textrm{cm}^2$) is 20\% higher at the bottom of the camera than at the top.
Combined with the fact that an observing target can move several degrees over one \SI{30}{min} observation, this means the airmass can change by 10's of percent over a single 30-minute observation.
This changing atmosphere would mean the IRFs at the beginning of an observation may be measurably different than at the end of an observation.

To reduce the impact of this, observations are broken up into 8-minute-long parts.
For each of these 8 minute parts, IRFs are exported alongside the observation.
A part's average elevation, azimuth, and night sky background rate are used to select the best-matching IRFs for that part.

The next subsections discuss each IRF individually.
The effective areas are described in Section~\ref{subsec:effarea}, the point spread function in Section~\ref{subsec:psf}, the background models in Section~\ref{background_production}, and the energy dispersion in Section~\ref{subsec:edisp}.

\FloatBarrier
  
\subsection{Effective Area}\label{subsec:effarea}
% use effective area as a casual noun!
% plot of effective area vs energy
Effective area is the measure of how large an observatory's collection area is, which determines how many gamma rays can be detected per unit time, solid angle, and energy.
The effective areas are calculated with \nicetilde 25 million Monte Carlo gamma-ray shower simulations for each point in the atmosphere/elevation/noise/offset parameter space.
% where $VERITAS_USER_DATA_DIR = /lustre/fs19/group/cta/users/nkelhos/VERITAS/
% see $VERITAS_USER_DATA_DIR/figure_out_number_of_simulated_showers/read.py
% run read.py, number of packets is roughly the number of showers, after core 
% rescattering and offset wobbling for one point in the parameter space
% # of points:
%   10 elevations
%    2 atmospheres
%    9 wobbles
%    9 noises (care only, grisu doesn't simulate noise)
This is done in the shower plane, the plane perpendicular to the line drawn between a pointing target and the center of the observatory.
The effective area is then calculated via:
$A=\pi R^2 \frac{N_{\text{survived}}}{N_{\text{simulated}}}$
where R is the radius of the area within which simulated showers are directed to fall, $N_{\text{simulated}}$ is the number of showers that were initially simulated into the area, and $N_{\text{survived}}$ is the number of simulated showers that pass all cuts.
This effective area is thus a measure of how much detection area the observatory would have if it had a 100\% detection efficiency, which can then be used in calculating a source's flux.
Figure~\ref{fig:effarea_paramspace} shows how the effective area peaks to \nicetilde{}\SI{3e5}{m${}^2$} for \SI{3}{\TeV{}} events at the camera center.

\begin{figure}[!t]
  \centering
  \includegraphics[width=0.85\textwidth]{images/effarea_plots/effarea_space.pdf}
  \caption[Effective Area Parameter Space]{
    Effective areas at different points in the energy and camera offset parameter space for run 78128.
    Data is shown as the black points, indicating the position of some events from that run in the parameter space.
    The color axis indicates the effective area, calculated from simulations, at different gamma-ray energies and distances from the camera center.
  }
  \label{fig:effarea_paramspace}
\end{figure}

For the the Crab Nebula and Sgr A* data, the effective areas of all events are shown in Figure~\ref{fig:effarea_usage}.
The Crab Nebula acts as a known \textit{standard candle} source to test out the analysis, before attempting to search for dark matter within the Sgr A* data.
    
    \begin{figure}[!t]
      \centering
      \begin{tabular}{c}
        \includegraphics[width=0.85\textwidth]{images/effarea_plots/effarea_events_crab.pdf} \\
        \includegraphics[width=0.85\textwidth]{images/effarea_plots/effarea_events_sgra.pdf}
      \end{tabular}
      \caption[Effective Areas Used]{
      Illustration of the effective areas used by all events in each analysis.
      From these plots, it is easy to check for events with anomalously high (>\SI{400000}{m${}^2$}) or low (\nicetilde\SI{0}{m${}^2$}) effective areas.
      }
      \label{fig:effarea_usage}
    \end{figure}
  
  \FloatBarrier

  \subsection{Point Spread Function}\label{subsec:psf}

    When reconstructing the source position of each gamma ray, it is necessary to know the uncertainty of the position.
    Errors in the position primarily come from the randomness of shower images.
    The same gamma ray may develop varying outcomes due to differences in which:
    \begin{itemize}[label=$\bullet$,noitemsep]
      \item particles early in the shower gaining different amounts of energy
      \item angles shower particles scatter at
      \item Cherenkov photons are absorbed by the atmosphere
      \item Cherenkov photons are reflected by the mirrors
      \item Cherenkov photons are converted into PMT photoelectrons
    \end{itemize}
    In the image and position reconstruction, these all means that the same initial gamma ray can develop into a distribution of camera images and reconstructed positions.
    Inversely, a single reconstructed position can come from a distribution of true gamma-ray positions.

    This distribution of reconstructed positions is called the point spread function, and primarily affects the reconstructed shape of gamma-ray emission structures in the sky.
    A singular point source, nominally shaped by a Dirac function, is instead distributed out according to the PSF.
    When searching for an extended source, like a dark matter halo, understanding the distribution of reconstructed positions is important.
    A large PSF on all events, for instance, will artificially expand the observed dark matter halo.

    For VERITAS, the PSF is estimated by simulating many gamma rays, then measuring the distribution of true positions for each reconstructed position.
    The distribution of event positions are fitted with a King function~\cite{king1962} (see Equation~\ref{eqn:king}), as this better models the longer PSF tails at lower elevations (Section 5.2.2 in Ref. \cite{Mayer2015}).
    The radially-normalized King probability density function is defined as

    \begin{equation} \label{eqn:king}
    \text{PSF}_{king}(r) = \frac{1}{2 \pi \sigma^{2} } \left( 1 - \frac{1}{\gamma} \right) \left( 1 + \frac{ r^{2} }{ 2 \gamma \sigma^{2} } \right)^{-\gamma}
    \end{equation}

    where $r$ is the angular distance from the reconstructed position, $\sigma$ is analogous to the width of a gaussian, and $\gamma$ governs how long the tails are.
    A King function fitting algorithm was added to Eventdisplay, that fits the $\gamma$ and $\sigma$ parameters to a set of simulated gamma rays.
    This fits well over almost all of the parameter space.
    In Figure~\ref{fig:psf_paramspace}, the PSF is shown for one Sgr A* run.
    In it, one can see how the PSF containment radius changes vs reconstructed energy and offset from the camera's center.
    Other runs, which have different elevations, azimuths and NSB noise levels will have different values at each point in the energy/offset parameter space.

    % plot of psfs from chunkplot
    \begin{figure}[!ht]
      \centering
      \includegraphics[width=0.95\textwidth]{images/psf_king_plots/psf_parameter_space.pdf}
      \caption[PSF Parameter Space]{
        The 68\% containment radius for the energy/offset parameter space for Sgr A* run 78128. 
        The black points are from data, showing a subset of the event locations from run 78128 in the parameter space.
        The color axis is the containment radius, calculated from simulations.
        While events from all energies are shown, only events from \SIrange{4}{70}{\TeV{}} are used (see Section~\ref{sec:crab_analysis}).
      }
      \label{fig:psf_paramspace}
    \end{figure}

    For the Galactic Center and the Crab Nebula analyses, the distribution of 68\% containment radii for all events is shown in Figure~\ref{fig:gc_psf_hist}.

    \begin{figure}[!hb]
      \centering
      \begin{tabular}{c}
        \includegraphics[width=0.85\textwidth]{images/psf_gc_eventhist/eventpsf_crab.pdf} \\
        \includegraphics[width=0.85\textwidth]{images/psf_gc_eventhist/eventpsf_sgra.pdf}
      \end{tabular}
      %\includegraphics[width=0.85\textwidth]{images/psf_gc_eventhist/eventpsf.pdf}
      \caption[Crab and Galactic Center Event PSFs]{
        The 68\% containment radius for all Crab Nebula and Sgr A* events used in this analysis.
        The asymmetric structure is due to the varying effective area at different offsets and energies, which changes the distribution of events in the PSF table.
        The long tails are likely due to events at the edge of the observable energy and offset ranges, where the PSF gets worse.
      }
      \label{fig:gc_psf_hist}
    \end{figure}
  
  \FloatBarrier
  
  \subsection{Background Models}\label{background_production}
  
    A background model is a three-dimensional function in camera x (in angle, parallel to azimuth), camera y (in angle, parallel to elevation), and energy.
    Each background model is constructed from one of two templates, and the templates are built from dark run observations (see Figure~\ref{fig:gcfieldsofview}).
    These background models calculate the number of expected events in the camera, per unit solid angle, unit time, and unit energy.
    This is used to quantify how many counts are expected in different parts of the camera when observing any target.
    Understanding the background shape of the camera is crucial for properly studying extended sources, like dark matter halos, which may extend several degrees from the Galactic Center.
    Improperly estimating background models can result in fake structures appearing around an astrophysical target.
    Background models with more than three dimensions are also possible, but require many more simulations, and are beyond the scope of this thesis.
    
    The background models used in this analysis are made from two background templates, one for each of the V5/V6 epochs (see Section~\ref{sec:epochs}).
    The templates are constructed from dark observations, detailed later in \ref{veritasdata}.
    Each template is made by binning all background events radially by camera position and by their energy, to produce a spectral function.
    This spectral function can be seen in Figure~\ref{fig:background_profile}.
    The radial function at two different energies is shown in Figure~\ref{fig:background_radial}.

    \begin{figure}[!p]
      \centering
      \includegraphics[width=0.6\textwidth]{images/ctools_background/background_construction.eps}
      \caption[CTOOLS Background Fine Energy Bins]{
        The V5 background's fine energy bins.
        The top plot shows the number of events in each fine energy bin from all background runs.
        The bottom plot shows the background rate, the number of background events divided by the observation time, solid angle, and energy span.
        The black lines show the background rate in each energy bin, while the blue line shows the used background rate after interpolation is applied.
      }
      \label{fig:background_profile}
    \end{figure}

    \begin{figure}[!hb]
      \centering
      \includegraphics[width=0.5\textwidth]{images/ctools_background/radial_profiles.eps}
      \caption[CTOOLS Radial Background Profiles]{
        Radial bin profiles for the V5 background's two large-scale energy bins.
        The blue points are the counts per bin area, while the purple line is a spline interpolation with a 3rd order polynomial.
        The peak and plateau at \ang{0}-\ang{1} is due to the background events not being radially symmetric in the camera, due to the changing atmospheric depth across the camera's field of view.
        For fitting the interpolated curve, the bin values at angles less than \ang{0} and greater than \ang{2.5} are copied from the \ang{0} and \ang{2.5} bins, respectively.
        }
      \label{fig:background_radial}
    \end{figure}
    
    Finally, the spatial and spectral functions $M_{s} \left ( e \right )$ and $M_e \left(x,y,e \right )$ are multiplied together in Equation~\ref{eqn:bck_template}.
    
    \begin{equation}\label{eqn:bck_template}
      f(e,x,y) = A \, \times \, M_{e} \left ( e \right ) \, \times \, M_{s} \left ( x, y, e \right )
    \end{equation} 
    
    The function $f(e,x,a)$ has units of $\frac{\textrm{Number of Counts}}{ \textrm{MeV} \times \textrm{s} \times \textrm{sr} }$.
    The multiplied functions are then scaled with a constant $A$ such that the total integral of the template (integrating across camera x, camera y, and energy) is equal to the original number of counts in the dark runs, as in Equation~\ref{eqn:background_template_function}.
    
    \begin{equation}\label{eqn:background_template_function}
      \textrm{Number of Background Events} = A \, \int \, M_{e} \left ( e \right ) \, \times \, M_{s} \left ( x, y, e \right ) \; dx \: dy \: de
    \end{equation}

    This function $f(e,x,y)$ is the background template in camera x/y, which due to its radial symmetry can then immediatly be used as a CTOOLS background model in RA/Dec.
    Each background template is used in the likelihood analysis as a model multiplied by two free parameters, a normalization factor, and the event energy exponentiated by the spectral index.
    This lets the likelihood fitter scale each run's background model up or down to best match the number of observed events.
    This means the background's absolute value is less important than the relative values in different parts of the camera background or at different energies.
  
  \FloatBarrier

  \subsection{Energy Dispersion}\label{subsec:edisp}
    As events are reconstructed imperfectly, it is important to understand what the distribution of reconstructed energies are for a given true energy.
    This \textit{dispersion in energy} is quantified by an energy migration matrix $E_{i,j}$, where $i$ denotes the $i^{\text{th}}$ reconstructed energy bin, and $j$ denotes the $j^{\text{th}}$ true energy bin.
    The energy migration matrix can be used to account for two significant effects.
    The first is that the reconstruction method introduces biases in the event energy, meaning an event at a given true energy can be reconstructed on average at a higher or lower energy.
    The second effect that is accounted for is the dispersion in the reconstructed energies.
    Gamma rays with the same energy will have their energies reconstructed as a distribution close to the true energy.
    These fluctuations can be due to randomness in air shower development or atmospheric absorption of Cherenkov photons.
    This has the effect of distributing events in each energy bin of a spectra.
    In the gamma-ray spectra of astrophysical sources, which often follow a power law, lower energy bins tend to have more events than higher energy bins.
    This results in lower-energy dispersion contributing more to the higher-energy bins than the higher-energy dispersion contributes to the lower-energy bins.
    When not accounted for, this has the effect that the energy dispersion will harden observed astrophysical spectra.
    In Figure~\ref{fig:migmatrix}, a migration matrix is shown.

    \begin{figure}[!th]
      \centering
      \includegraphics[width=0.85\textwidth]{images/edisp_plots/edisp.pdf}
      \caption[Energy Migration Matrix]{
        An energy migration matrix used with Sgr A* run 82288.
        The reconstructed energy is on the x-axis, and the true energy is on the y-axis.
        The z (color) axis denotes the interpolated number of simulated events that passed all cuts.
        The dark-blue region from \SIrange{4}{70}{TeV} \EReco{} is the range of energies used in this analysis.
        Events at a given \ETrue{} are reconstructed at a spread of \EReco{}.
        This spread is due to the variability in how air showers develop in the atmosphere.
        Small variations early in the shower can have a large impact on the shower's cherenkov image, meaning the shower can appear as though it was from a higher- or lower-energy gamma ray.
        At the lowest \ETrue{} energies, some showers fluctuate upwards to produce higher amounts of Cherenkov light get reconstructed to higher \EReco{} energies.
        At the highest \ETrue{} energies, showers may be so large that they fill the entire camera, leading to lost photons past the edge of the camera, causing the shower's energy to be reconstructed lower than it actually is.
      }
      \label{fig:migmatrix}
    \end{figure}
  
  \FloatBarrier

\section{Camera Studies}
  The objective of this thesis is search for dark matter via the existence of a gamma-ray halo that is both extended and faint.
  The extension and faintness of the halo, plus the relativly large amount of noise near the Galactic Center, make it a priority for understanding how the VERITAS camera behaves in high-noise conditions.
  In order to better understand the camera's behavior in the reconstruction method, several studies were performed.

  \subsection{Background Structure at the Low Energy Threshold}\label{subsec:bkgstructure}
    To produce background models, events were binned according to their energy, telescope pointing elevation, and elevation and azimuth about the camera center.
    As a result of this detailed binning, some new effects were noted.
    First, Sgr A* Off data was reconstructed, which has no known gamma-ray source in its field of view.
    The time spent at each telescope elevation is shown in Figure~\ref{fig:back_elevhist}.
    To reduce the effect of the varying telescope elevation, time cuts were applied to select data between \ang{28.5} and \ang{29.5} telescope elevations.
    This was done to reduce any effects of a large range of telescope elevations.
    Because the shape of the atmospheric interaction volume strongly depends on the telescope elevation, a small elevation range helps isolate atmosphere-dependent effects.
    Note that this is a cut on the telescope pointing, not on the actual event elevations.

    \begin{figure}[bt]
      \centering
      \includegraphics[width=0.6\textwidth]{images/background_gradient_replot/sgraoff_1_hist_elev.pdf}
      \caption[Elevation Slice of Sgr A* Off data]{
        Time spent pointing the observatory at each elevation.
        Blue is all Sgr A* Off data, while green is the selected pointing elevations used in Figure~\ref{fig:background_grid}.
      }
      \label{fig:back_elevhist}
    \end{figure}
    
    Gamma-like events were then selected from this data, and binned in energy in Figure~\ref{fig:background_grid}.
    The left histograms show the number of events at each energy, with the expected more events at lower energies.
    For each row, a different energy range is selected, shown in green in the left plot.
    The cuts to pointing-elevation  and energy are applied, the surviving events are then histogrammed in the right-hand plots according to their azimuth and elevation in the camera.
    These 2D histograms are almost identical to the camera backgrounds described in Section~\ref{background_production}, differing only by dividing by the bin size in energy, time, and solid angle.
    
    \begin{figure}[p]
      \centering
      \begin{tabular}{rl}
        \subfloat{\includegraphics[width=7.5cm]{images/background_gradient_replot/sgraoff_1_hist_energy.pdf}} & 
        \subfloat{\includegraphics[width=4.5cm]{images/background_gradient_replot/sgraoff_1_cam.pdf}}         \\
        \subfloat{\includegraphics[width=7.5cm]{images/background_gradient_replot/sgraoff_2_hist_energy.pdf}} & 
        \subfloat{\includegraphics[width=4.5cm]{images/background_gradient_replot/sgraoff_2_cam.pdf}}         \\
        \subfloat{\includegraphics[width=7.5cm]{images/background_gradient_replot/sgraoff_3_hist_energy.pdf}} & 
        \subfloat{\includegraphics[width=4.5cm]{images/background_gradient_replot/sgraoff_3_cam.pdf}}         \\
        \subfloat{\includegraphics[width=7.5cm]{images/background_gradient_replot/sgraoff_4_hist_energy.pdf}} & 
        \subfloat{\includegraphics[width=4.5cm]{images/background_gradient_replot/sgraoff_4_cam.pdf}} 
      \end{tabular}
      \caption[Atmospheric Gradient in the VERITAS Camera]{
        Event energies and camera backgrounds after the pointing elevation cut shown in Figure~\ref{fig:back_elevhist}.
        In the left histograms, blue is all events while green is events in the selected energy range.
        The right shows 2D histograms, made from the camera azimuths and elevations using the green events selected in the histogram to its left.
        The orange dot and circle denote the average event position, and 68\% containment radius for the events in the plot.
        The \SIrange{1.8}{3.2}{TeV} energy range shows events are detected more in the upper half of the camera.
        From \SIrange{4}{6}{TeV}, events are more in the bottom half of the camera, while from \SIrange{6}{70}{TeV} events are closer to the camera center.
      }
      \label{fig:background_grid}
    \end{figure}
    
    As a measure of how far the events deviate from the camera center, an orange dot and circle are also plotted.
    These indicate the average event position, and the 68\% containment radius around that position.
    It can be seen in Figure~\ref{fig:background_grid} that at the lowest energies, events are reconstructed and pass cuts only in the top half of the camera.
    This physically makes sense, because at this low \ang{29} elevation, the atmospheric column density is \nicetilde20\% lower at the top of the camera than at the bottom.
    This allows lower-energy gamma rays and their shower's Cherenkov photons to get closer to the observatory.
    Below this energy, gamma rays do not produce enough Cherenkov photons to survive past the atmospheric scattering and PMT quantum efficiency.
    The bottom of the camera has more atmosphere however, and can be considered opaque to gamma rays \SI{2.5}{TeV} and lower.
    At higher energies a similar effect is also noted, where the events cluster in the bottom half of the camera more than the top half.
    As there is more atmosphere in that part of the camera, higher energy showers may be created further away, where the observatories can view a much larger volume of the atmosphere, detecting more showers.
    
    These effects are visible in the galactic ($l$,$b$) event maps from data.
    In Figure~\ref{fig:bkgvsel_crab}, the top plot shows the positions of all events from several hours of Crab Nebula data.
    The middle histogram shows the distribution of event energies, and the bottom plot shows the positions of events in a limited energy range, \SIrange{1.5}{3.25}{\TeV{}}.
    The middle plot indicates a specific energy range used in the bottom plot.
    When events in this limited energy range are plotted in the bottom plot, a faint deficit appears along the bottom of the camera.
    
    \begin{figure}[p]
      \centering
      \includegraphics[height=0.85\textheight]{images/background_vs_elevation/background_vs_elevation_srccrab.eps}
      \caption[Background Vs Elevation Crab Nebula]
      {\small 
        Plots of Crab Nebula observations.
        Top: Skymap of all events.
        Middle: Histogram of all events in energy.
        Bottom: Skymap of events from \SIrange{1.5}{3.25}{\TeV{}}.  
        The blue circles centered on the Crab Nebula highlight the radial symmetry of the top plot, and the lack of radial symmetry in the bottom plot.
      }
      \label{fig:bkgvsel_crab}
    \end{figure}
    
    \begin{figure}[p]
      \centering
      \includegraphics[height=0.85\textheight]{images/background_vs_elevation/background_vs_elevation_srcsgra.eps}
      \caption[Background Vs Elevation Sgr A*]
      {\small 
        Plots of Sgr A* observations.
        Top: Skymap of all events.
        Middle: Histogram of all event energies.
        Bottom: Skymap of events from \SIrange{1.5}{3.25}{\TeV{}}.  
        The blue circles centered on the Galactic Center highlight the radial symmetry of the top plot, and the lack of radial symmetry in the bottom plot.
      }
      \label{fig:bkgvsel_sgra}
    \end{figure}
    
    When similar plots are made for the Galactic Center in Figure~\ref{fig:bkgvsel_sgra}, the effect is much stronger, and rotated.
    In the top plot, events are radially symmetric around the source position.
    When only the events from \SIrange{1.5}{3.25}{\TeV{}} are plotted, a much clearer deficit is visible on the lower right part of the plot.
    This area corresponds to the deficit at the bottom of the low-energy camera plots in Figure \ref{fig:background_grid}.
    This rotation occurs when converting between camera x/y coordinates (Earth Elevation/Azimuth) and Galactic coordinates ($l$,$b$).
    The degree of rotation also changes from run to run, which further blurs this effect.
    For the Crab Nebula plots in Figure~\ref{fig:bkgvsel_crab}, the rotation is only a few degrees, while for Sgr A* in Figure~\ref{fig:bkgvsel_sgra}, it is closer to \ang{70}.
    
    This effect is important to the analysis because it implies that, at the lowest energies, the background rate is not radially symmetric.
    Radial backgrounds (sometimes referred to as acceptances) are typically used in VERITAS, as no other camera x/y or energy dependence had been demonstrated until now.
    Due to a limited amount of background data (see Table~\ref{tab:observation_times}), only radially-dependent backgrounds are used in this analysis.
    To attempt to reduce the effect of the non-uniform atmosphere, the event energies were limited to \SIrange{4}{70}{TeV}.
    Even with this limited energy range, the atmospheric effect is still prominant, and studied further in Section~\ref{sec:elevgradient}.
    
    Additional studies were performed to test if bright stars near the Galactic Center might affect a dark matter search, and are detailed in Appendix~\ref{app:starpixels}.
    Bright stars were found to have a negligible effect, and were ignored in this analysis.
    
    \FloatBarrier

