\cleartooddpage[\thispagestyle{empty}]
\chapter{Gamma Ray Reconstruction}\label{ch:grrecon}

In chapter \ref{chapter:veritas}, it was explained how the trigger system preserves PMT voltage traces of potential events.
To reconstruct gamma rays, the voltage traces caused by cherenkov light must be identified and combined into images of the original cherenkov shower.
Then shower images from multiple telescopes can be used to reconstruct the original gamma ray's energy and direction.

\section{Pedestal Variation}
Before reconstructing any events, the pedestal and pedestal variations must be calculated.
These are done by triggering all pixels once per second during normal data-taking, in order to record events caused solely by noise.
The average of the digital counts (dc) of all noise-events for each pixel is then the pedestal.
From this pedestal, the pedvar is then calculated as the rms of the noise-events, which can be visualized as the distribution of dc around the mean dc.

(also see \cite{Hanna2010NIM} about relative gains??)

\section{Pixel Identification}
The first step is to determine which pixels are part of a shower image or not.
This is done by integrating the total dc in each voltage trace, and finding the time of the peak charge (peak charge or Tzero??) in each pixel.
Around this peak charge time, the trace is integrated a second time with a smaller time window, to reduce accumulating charge from sources of noise (NSB and electronics)
This two-pass algorithm is usually referred to as the double-pass method (cite??).
If a pixel's second-pass total charge is higher than 5 times the pedvar, then it is considered an image pixel.
If it is between 2.5 and 5 times the pedvar, it is considered a border pixel.

\section{Image Reconstruction}\label{subsec:imgrecon}

Images are cleaned of extraneous pixels.
The time gradient is fit to each image.
From the time gradient, the dc (??) counts are integrated in a time window that moves with the time gradient of the shower.
Images are identified.

\section{Position Reconstruction}\label{subsec:posrecon}
Basic reconstruction of a shower's direction is done by geometry of the shower axes.
As all four telescopes are pointed at the same direction, all four images can be overlayed in camera coordinates.
In this coordinate system, the point of origin lies somewhere along the line of all shower image axes.
Thus, by weighting and averaging all axes intersection points, the original direction of the gamma ray can be found.

This can be improved through different algorithms, including the Disp method.

Images have their disp calculated.
The major axis of mulitiple images are traced.
The intersection of the axes, weighted by their disps the angles between axes, can then determine their original position.

\subsection{Angular Reconstruction Neural Network}
At high elevations, shower images are often at large intesection angles, while at lower elevations the intersections the images are more parallel (show example figure!??).
This means that when the reconstruction position is found by intersecting image axes, small changes in the image orientation can result in large movements in the reconstructed position.

To better handle these near-parallel image axes at low elevations, the reconstructed position can be determined from more parameters than just the weighted image axes intersection points.
From simulations, the distance between the center of the hillas shower image and the reconstructed position can be calculated, where the angular distance between the two is the 'disp' parameter\cite{Senturk:2011}, shown in figure \ref{fig:dispdiagram}.

Disp was first mentioned in \cite{Beilicke2012NIM}.

\begin{figure}[ht]
  \begin{center}
    \includegraphics[width=0.5\textwidth]{images/disp_diagram.eps}
    \caption[Angular Reconstruction Disp]{The disp parameter is the angular distance between the center (red dot) of a hillas image (blue oval) and the true sky position (green dot).  Generally, longer shower images have a larger disp angle.}\label{fig:dispdiagram}
  \end{center}
\end{figure}

% https://veritas.sao.arizona.edu/wiki/index.php/BDT_Angular_reconstruction
The disp and other parameters for thousands of simulated showers can then be used to train a neural network that calculates the most probable disp for a given shower.
This most probable disp can then be used with the image axes intersection points to more accurately reconstruct the original gamma-ray point of origin.

Once the training is complete, it is tested on a separate set of 17,000 simulated events, which are plotted in figure \ref{fig:disptraining}.
The x axis describes the true disp value for each event, while the y axis describes the disp value predicted by the Boosted Decision Tree network, with a black line for the x=y line.
As the majority of the events fall on the line, we can conclude that the BDTs are able to predict the correct disp value for most images.

% made from screenshot of last slide in Dropbox/Presentations/20160719_Group_Meeting.key
\begin{figure}[ht]
  \begin{center}
    \includegraphics[width=0.85\textwidth]{images/disp_training.eps}
    \caption[Disp BDT Training]{The true disp vs the BDT-predicted disp, for \nicetilde17,000 gamma-ray event images in T1, from 500GeV to 200TeV.}\label{fig:disptraining}
  \end{center}
\end{figure}

Improved angular resolution plot??

\section{Energy Reconstruction}\label{subsec:enrecon}
To reconstruct the energy of each shower, a database of simulated showers is built.
This database includes the width and length of the shower, how far away its core position is, how bright it was, as well as its reconstructed and true energy.
By scanning through this database for showers that are similar to the one being constructed, the most similar-looking shower then indicates the true energy(??).



\section{Sensitivity}
% plot vs energy
Sensitivity is a measure of how difficult it is to get a signifiant detection.
It is often quantified by using simulations to predict the amount of observation time required to detect a simulated source at a given significance level.


\section{Effective Area}
% plot of effective area vs energy
Effective area is the measure of how large an observatory's collection area is, determining how many gamma rays can be detected per unit time, per units source.

For each point in the parameter space, the effective areas are calculated with many Monte Carlo gamma ray simulations.
This is done in the shower plane, the plane perpendicular to the line drawn between an observing source, and the center of the observatory.
The effective area is then calculated via:
$A=\pi R^2 \frac{N_{survived}}{N_{simulated}}$
where R is the radius of the area within which simulated showers are directed to fall, $N_{simulated}$ is the number of showers that were initially simulated into the area, and $N_{survived}$ is the number of simulated showers that pass all cuts.
This 'Effective' area is thus a measure of how much detection area the observatory would have if it had a 100\% detection efficiency, which can then be used in calculating a source's flux.



\section{Energy Resolution}
% plot of energy resolution
Gamma rays and protons of different energies can produce similar-looking air showers.
Due to this, the reconstruction software cannot perfectly reconstruct gamma rays, which introduces errors into the different qualities of the gamma rays.
This means that when a gamma ray is reconstructed, it has a chance to be reconstructed at a lower or higher energy.
The consequence of this is that gamma rays of a given reconstructed energy can come from a distribution of true simulated energies.
Typically, simulations are run across a number of energies, and an 2D matrix is assembled, where one axis is the true simulated energy, and the other axis is bins of reconstructed energy.


\section{Point Spread Function}\label{sec:psf}
% plot of psf
In addition to the energy being slightly mis-reconstructed, the source position of the gamma ray can also be misreconstructed.
For a gamma ray telescope, a simple measure of this misreconstruction is to simulate many gamma rays at a single point in the sky, and look at how their reconstructed positions are distributed around that point.
This distribution is referred to as the Point Spread Function.
To first order, most current-generation point spread functions are gaussian distributions.


\section{Energy Dispersion}
Much like the point spread function in section \ref{sec:psf}, the energy reconstruction process is also imperfect.
This means that a gamma ray with a reconstructed energy could come from a distribution of true energies.
This can also be phrased that a group of gamma-rays with the same initial energy will have a distribution of reconstructed energies.
These distributions primarily are due to inherent randomness in the showers themselves.


\section{Energy Sensitivity and Zenith Angle}
% plot of energy sensitivity at 20zen and 65zen

As the telescope points at a lower elevation, the atmospheric volume that can be used to detect air showers greatly increases, leading to an increase in the telescope's effective areafor high energy showers.
The downside is that fewer low-energy gamma rays reach the volume of atmosphere being observed, 


\section{Comparison with Other Observatories}

% sensitivity comparison plots

CTA, HESS, Magic, HAWC, Fermi

\section{FITS Conversion for Gammalib and CTOOLs}

Once gamma rays have been reconstructed with event display, they must be converted to a FITS file format compatible with gammalib.
This format consists of a FITS file with an event list table, containing each gamma ray, its energy, position, and time.
This also includes meta information about the event list like the telescope's pointing target and the start and end times of the event list.
This FITS file can then be read into Gammalib and CTOOLS (cite??).

In addition to the event list, the instrument response functions (IRFs) must also be imported into Gammalib and Ctools.
These include effective areas, point spread funciton, energy dispersion, and background shapes for several dimensions in the IRF parameter space (energy, offset from camera center, telescope elevation/azimuth, noise, etc).
By default, all IRFs are stored in a single database, and each event list contains a reference to which part of the parameter space should be used with it.

However, the galactic center is at an elevation of $\ang{30}$, much lower than most VERITAS observation targets.
At this elevation, with its field of view of $\ang{3.5}$, the air mass column density ($g/cm^{2}$) is 20\% higher at the bottom of the camera than at the top.
Add to this that during a single 30 minute observation, the elevation of the Galactic Center can change by several degrees, means the airmass in view of the camera may change rapidly, meaning the IRFs may become time dependent.

To allow for this time dependence in the analysis, an alternate way of storing the IRFs was chosen, diagrammed in figure \ref{fig:fits_scheme}.
First, one observation (typically 20-30 minutes long) is broken up into \nicetilde3 minute chunks.
Each chunk is then converted to an event list, and saved to a FITS file.
In addition, the needed Effective Area, PSF, and background tables are also written to the same FITS file.
As each event list covers a small region in time, the IRF tables only need to contain the dimensions of the parameter space that can change during one chunk, such as event energy and distance from camera center.

\begin{figure}[ht]
  \begin{center}
    \includegraphics[width=0.75\textwidth]{images/FITS_diagrams_alternate_scheme.eps}
    \caption[FITS File Event Storage Schemes]{}\label{fig:fits_scheme}
  \end{center}
\end{figure}

The end result is that a 30 minute observation can be broken into \nicetilde10 FITS files (called chunks), where each chunk file is independent of any outside references, contains all IRF needed information, and only takes up \nicetilde100s KB.
This makes it ideal for an analysis program to automatically download any needed data over an internet connection, as each chunk is tiny and has no outside dependencies.
As gammalib and CTOOLS expect the default FITS file scheme, a python function was written to automatically load all event and irf tables from a single fits file, and import this information into gammalib's GObservation class.

There were minor issues with converting the IRFs that are noted in the following sections.

\subsection{PSF Fitting}

The psf is the distribution of true event directions for a given reconstructed event direction, as a function of distance from the reconstructed event direction.
In order to use Event Display's psf in ctools, some conversion is necessary.

Event display natively stores its psf as a pair of 68\% and 80\% containment radii (referred to as r68 and r80, respectivly), each as a distance in degrees between the monte carlo event direction and the reconstructed direction.
These radii contain 68\% and 80\% of all events in the distribution, and are used to fit a gaussian profile.
For ctools, a king function is used instead of a gaussian.

$$ psf_{king}(r) = \frac{1}{2 \pi \sigma^{2} } \left( 1 - \frac{1}{\gamma} \right) \left( 1 + \frac{ r^{2} }{ 2 \gamma \sigma^{2} } \right) $$

A king function fitting algorithm was added, that fits for the $\gamma$ and $\sigma$ parameters, from the same distribution of events that the r68 and r80 radii are calculated from.
This leads to good fits over almost all of the parameter space.

(example fit image of distribution of events and fitted king function ??)

A smaller psf is important for this analysis, as the presence of a dark matter halo relys on the pointing accuracy of the events around the galactic center.
A worse gamma-ray psf (with a wider distribution of possible true positions) will smear out any dark matter halo around the galactic center, making its detection more difficult.


\subsection{Background Templates}

To produce a background, events are binned in camera coordinates and energy, and each bin is divided by the size of the bin's exposure in time, energy, and solid angle.
This allows for the likelihood engine to model the expected camera background of cosmic-ray events that pass all gamma-like cuts.
As the likelihood engine will apply a scale value to the background as part of its fitting, the background's absolute values matter much less than its relative values.

During the production of the initial low elevation background, some new effects were noted.
First a series of gamma-like events were taken from observations with no known gamma-ray sources.
These events are then divided into equal-statistics bins.
For each equal-statistic energy bin, all the contained events are binned in camera X and Y.

For a set of high-elevation observations, these backgrounds are shown in figure \ref{fig:back_highelev}.
It can be seen that all events are divided up into 3 equal-statistics energy bins in figure \ref{fig:back_highelev}.A.
Each energy bin is then binned in camera X and Y in figure \ref{fig:back_highelev}.B, .C, and .D.
It can be seen that at these high elevations, each energy bin is radially symmetric about the camera center.
This happens because gamma ray's point of origin and its shower image in the camera are usually several tenths of a degree away from each other.

\begin{figure}[ht]
  \begin{center}
    \includegraphics[width=\textwidth]{images/ctools/backgrounds_highelev.eps}
    \caption[FITS Background at High Elevations]{Gamma-like Events from 52 observations(livetime??) of M82 (in what elevation range??).  Events in Figure A are divided into 3 equal-statistics energy bins, and binned in Camera Coordinates in Figures B, C, and D.}\label{fig:back_highelev}
  \end{center}
\end{figure}


In figure \ref{fig:back_lowelev29} and figure \ref{fig:back_lowelev26}, the same plots are constructed for a set of low-elevation ($ \nicetilde \ang{29} $ and $ \nicetilde \ang{26} $ respectivly)) observations, using Galactic Center Off observations.
These are again divided in to equal-statistic energy bins, and then each energy bin is binned in camera coordinates.
It can be seen that in different energy bins, the background possesses different shapes.

\begin{figure}[ht]
  \begin{center}
    \includegraphics[width=\textwidth]{images/ctools/backgrounds_lowelev29.eps}
    \caption[CTOOLS Background at 29 degrees Elevation]{15(livetime??) Sagittarius A* Off runs, between elevations $ \ang{27.5} $ and $ \ang{30} $.  Events are divided into 6 equal-statistics energy bins, of which four are binned in Camera Coordinates in figures B, C, D, and E.}\label{fig:back_lowelev29}
  \end{center}
\end{figure}

\begin{figure}[ht]
  \begin{center}
    \includegraphics[width=\textwidth]{images/ctools/backgrounds_lowelev26.eps}
    \caption[CTOOLS Background at 26 degrees Elevation]{10(livetime??) Sagittarius A* Off runs, between elevations $ \ang{24} $ and $ \ang{27.5} $. }\label{fig:back_lowelev26}
  \end{center}
\end{figure}






